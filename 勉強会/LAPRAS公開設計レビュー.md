## [前編](https://youtu.be/C0UZXqIz80c)

- デプロイのロールバックについて
  - デプロイ自動化は、ロールバックの自動化とセットになっている必要がある
    - 自動ロールバックできるなら、リリース前に手動確認は不要
      - リリース後にエラー率を監視して、一定以上エラーが出たらロールバックするなど
      - 本番環境もテストの一部と捉える
    - 戻す技術と進む技術はワンセット

- 機械は決められた動作のテストが得意で、人は意図しない動作を含むテスト(探索的)が得意
  - なので、人は探索的な動作に時間を使いたい
    - こうやったら壊れるんじゃないか？的な意地悪なテストは人間が得意

- リリースとデプロイの違い
  - リリース: 本番環境にデプロイし、お客さんに提供する
  - デプロイ: 本番環境にデプロイするだけで、お客さんには提供しない(CBT, OBTなど)

- flaky test
  - コード自体は正しいが、確率で落ちてしまうテスト
    - コードは悪くないので、原因の判別がしづらい
  - テストの失敗に鈍感になるので良くない
    - 「まあリトライして通ればいいか」的な
    - リトライを自動化してしまうのは良くない
    - 本当は一回目で落ちたらダメなテストの失敗にも気づけなくなる
  - flakyになりやすい箇所
    - テスト範囲が増えるほどflakyになる
      - E2Eがいい例
  - 対策
    - 大掛かりになるが、テストの履歴を取るという手法もある
    - テスティングフレームワークのタグ機能を利用する
      - RSpecにもあった
      - flakyなテストにflakyタグをつける
        - flakyテストが落ちるのを許容する判断ができるようになる

- 時刻のテスト
  - ランダムさは、時々未知の不具合を教えてくれる
    - property based testing
      - これによって不具合を検知できたら、開発者がその値のテストを追加して不具合を修正する
        - 未知を既知に変えられる

- レイヤごとに同じようなテストが追加されがち問題
  - APIレベルでのfeatureテストと、ドメイン層で同じアサーションを書いてしまう
  - レイヤごとに方針が決まっていないのが問題
    - どのレイヤで何をテストしておくのか決めておくのが理想
  - テストピラミッドでは、異常系のテストは基本的に下の階層(Unitテストとか)で行い、上の階層(E2Eテストとか)では正常系の割合が多くなるのが理想

## [後編](https://youtu.be/O4QwiGsRTJc)

- テストが書かれていなレガシーコードのテストは難しい
  - テストすることを前提に書かれていないから
  - 大外から包むテスト（スモークテスト）を書く
    - APIレベルの結合テストなどで、振る舞いをテストする
  - レガシーコードのうち、どこからテストを書くか
    - 機能として優先度が高い箇所
    - 元々不具合がある箇所
      - そこにテストを書いてるうち、顕在化してない不具合を発見できることが多い
        - コスパ高い
        - ヤバイ箇所は、その周辺もヤバイ

- レガシーコードに対しては、どうあるべきかは忘れて良い
  - どうあるべきかより、今どうなっているかを検証したい
  - どうあるべきかはすでに失われてる可能性が高い
    - 書いた人や仕様を知っている人が退職してる

- ビジュアルリグレッションテスト
  - 画面のスクショを解析して、UIの差分をテストする
  - リグレッションテストはどうあるべきかより、今どうなっているか（状態の差分）のテスト

- 新規のアプリケーションを作るとき、初期段階でどこまでテストを書くか

- 設計が固まってないからこそTDDで作る

- RailsなどのMVCのFWでの設計
  - 速度を維持しつつ、コアのドメインがFWに依存しないようにしたい
    - トレードオフを考える
      - モデルからメールはマズい、モデルからDBはOKなど
  - Railsは初心者向けではなく、中上級者向け
    - 理解している人が高速で開発するためのFW

- e2eテストのシナリオ
  - ユーザーが目的を達成できること
    - それが価値
  - e2eの目的は、それが継続できていることのテスト

- テストを消す基準
  - むずい
  - ボーイスカウト的に消していくとか
  - 自動化するのは難しいし、コスパ悪い
  - ペアプロで相談しながらやるのおすすめ

- モックについて
  - モックを使うか/使わないか、テストファーストかどうかという二軸の話
    - ロンドン派
      - テストファーストの道具としてモックを使う
        - 本物が準備できてない段階でモックを使ってテストを書いていくという思想
        - 後からモックを使っていくという話ではない
    - デトロイト派
      - テストファーストだが、極力モックを使わない
        - ローカルで用意できるものは本物を使う
        - Fakeオブジェクトがある場合はそれを使う
        - 本物を使って遅くなる場合は、マシンやクラウドの性能を上げて解決する(お金で解決)
  - privateメソッド、クラスメソッドのモックができるとかは、そもそもテストを書きにくいことの根本的な改善にならない
    - 設計をよくするのが大事
    - 設計が悪くてもモックを書けます！というのは本質ではない

- サバンナで生き抜くためには
  - テストの原則を抑えつつ、技術の進化で解決可能になった課題にも目を向ける
