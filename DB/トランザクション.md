# トランザクションのメモ

- 同時実行制御とクラッシュリカバリが重要

- 直列で実行すれば良くない？
  - 処理効率が良くない。コンピュータの性能を限界まで引き出したいなら並列。ただし、直列に処理した結果と同じになるように並列処理しなければいけない

- データの正しさとは
  - 直列で実行した時（直列化されたスケジュール）と同じ結果になること

- スケジューラの性能
  - どれだけ並列処理できるか
  - どれだけ最適なスケジュールを選択できるか

- 原子性
  - commitかabortかのどちらかが行われることを保証する
  - アプリケーションではabort時の対応はしなければいけない(リトライ処理など)

- 一貫性
  - トランザクションの前後では一貫性は保証される
    - ある一貫性のある状態から、別の一貫性のある状態へ変化する
    - DBの機能だけでは一貫性のある状態を保証できない。アプリケーション側でも考える必要はある

- 分離性
  - 個々のトランザクションは、同時に実行されている他のトランザクションに影響を与えない
    - 並列で実行されるトランザクションは直列で実行された時と同じ実行結果になること

- 永続性
  - コミットが完了したトランザクションが消失しないという性質
    - マシンがクラッシュしても、コミットが完了したデータは消失しない

## トランザクションで防ぎたい問題問題

- ロストアップデート
  - あるトランザクションが別のトランザクションの更新前の値を参照できてしまうことによって起きる問題

- インコンシステントリード
  - あるトランザクションの結果が別のトランザクションに影響を与えることによって起きる問題。影響を受けたトランザクションでは読み取りの結果が整合性が取れていない状態になる

- ダーティリード
  - あるトランザクション内で変更したコミット前のデータを他のトランザクションから参照できることによって起きる問題
    - あるトランザクションaで変更したコミット前のデータを他のトランザクションbから参照した後、aがabortした際、bで参照したデータは不正なデータになる

- ノンリピータブルリード
  - あるトランザクション内で同じデータを複数回読み取った際、そのトランザクション内で書き込みをしていないにも関わらず値が変わってしまう問題
    - インコンシステントリードと混同しやすい。複数のデータにわたって整合性が出るのがインコンシステントリード

- ファントムリード
  - 上の4つとは異なり、既存のデータの変更ではなく新しく追加されたデータによってトランザクション内での読み取り結果が変わる問題

## スケジュール

- ロッキングスケジューラ
  - トランザクションの並列実行において、ロックを用いてスケジュールを制御する方法。最も一般的
  - web開発におけるトランザクションの話は暗黙的にこのロッキングスケジューラを用いた話であることが多い
  - SQL実行時に排他ロックを行う
    - 操作対象となる行に、処理を行う前にロックをかける→競合するデータアイテムへのアクセスを必要とする処理はブロックされる→整合性のあるスケジュールとなる

- デッドロック
  - ロッキングスケジューラを持つアプリでは避けられない
  - デッドロックが起こった場合、両方ともロールバックするのか、片方だけロールバックするのかは実装によって異なる

## トランザクション分離レベル

Serializableが一番整合性が高いが、処理効率が悪い。そのため、ほとんどの処理は他の分離レベルを採用することが多い
READ-UNCOMMITEDはダーティーリードを許容するため、ほぼ使わない

トランザクション分離レベルをいじるのはメンテナンスコストが非常に高いため、使っているRDBMSのデフォルトのトランザクション分離レベルを用いるのが無難

`select for update`は明示的にSERIALIZABLEにする

MVCC(Multi Version Concurrency Control)

- 並列性を高めるため、インコンシステントリードが起きない範囲であるトランザクションでの更新前の値を他のトランザクションが読み取ることを許容する
  - 時間のかかるトランザクションでは他のトランザクションからの読み取りも長時間ロックしてしまうため
  - 読み取りのみのトランザクションで利用されることが多い

## クラッシュリカバリ

並列で実行されたトランザクションを直列で実行した場合のスケジュールは、「スケジュールログ」という不揮発性の領域に保存される。クラッシュした場合、このスケジュールログを使って復元する(永続性)
